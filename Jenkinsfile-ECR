@Library('my-shared-library') _
pipeline {
    
    agent any
    parameters{

        choice(name:'action',choices:'create\ndelete',description:'choose create/destroy')
        string(name: 'aws_account_id', description: " AWS Account ID", defaultValue: '863035722089')
        string(name: 'Region', description: "Region of ECR", defaultValue: 'ap-south-1')
        string(name: 'ECR_REPO_NAME', description: "name of the ECR", defaultValue: 'navedali')
    }
    stages{
        
        stage ("Git checkout"){
            when { expression { params.action == 'create'}}
            steps{
                gitCheckout(
                    branch: "main",
                    url: "https://github.com/navedalisayyed/CICD-pipeline.git"
                )
                   

            }

        }
        stage ("MVN unit test"){
            when { expression { params.action == 'create'}}    
            steps{
               script{
                  mvnTest()
               }

            }

        }
        stage ("MVN integration test"){
            when { expression { params.action == 'create'}}    
            steps{
               script{
                  mvnIntegrationTest()
               }

            }
  
        }
        // stage ("Static code analysis:sonarqube"){
        //     when { expression { params.action == 'create'}}    
        //     steps{
        //        script{
        //            def SonarQubecredentialsId = 'sonar-api'
        //            statiCodeAnalysis(SonarQubecredentialsId)
        //        }

        //     }
 
        // }
        // stage ("Qaulity gate status check:sonarqube"){
        //     when { expression { params.action == 'create'}}    
        //     steps{
        //        script{
        //            def SonarQubecredentialsId = 'sonar-api'
        //            QualityGateStatus(SonarQubecredentialsId)
        //        }

        //     }
    
        // }
        stage ("Maven Build"){
            when { expression { params.action == 'create'}}    
            steps{
               script{

                   mvnBuild()
               }

            }
       
        }
        stage ("Docker Image Build:ECR"){
            when { expression { params.action == 'create'}}    
            steps{
               script{

                   dockerBuild("${params.aws_account_id}","${params.Region}","${params.ECR_REPO_NAME}")
               }

            }
       
        }
        stage ("Docker Image Push:ECR"){
            when { expression { params.action == 'create'}}    
            steps{
               script{

                   dockerImagePush("${params.aws_account_id}","${params.Region}","${params.ECR_REPO_NAME}")
               }

            }
        }
    }     
}    